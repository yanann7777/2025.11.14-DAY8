/**
 * app.js - ç‹—ç‹—å¹´é½¡è¨ˆç®—æ©Ÿ
 * åŒ…å« LocalStorage å„²å­˜å’Œè¼‰å…¥é‚è¼¯
 */

// --- å¸¸é‡å®šç¾© ---
const STORAGE_KEY = "dogAgeCalculatorData";
const dogNameInput = document.getElementById("dogName");
const birthDateInput = document.getElementById("birthDate");
const calcBtn = document.getElementById("calcBtn");
const resultBox = document.getElementById("result");


// --- å¹´é½¡è¨ˆç®—èˆ‡é¡¯ç¤ºçš„æ ¸å¿ƒå‡½æ•¸ ---
function calculateAndDisplayAge() {
    const dogName = dogNameInput.value.trim();
    const birthDateStr = birthDateInput.value;
    const birthDate = new Date(birthDateStr);
    const today = new Date();

    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
    if (!birthDateStr || isNaN(birthDate)) {
        resultBox.innerHTML = "<p style='color:#c0392b;'>âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‹—ç‹—å‡ºç”Ÿæ—¥æœŸã€‚</p>";
        // æ¸…é™¤ä¸Šæ¬¡çµæœ
        localStorage.removeItem(STORAGE_KEY);
        return;
    }

    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœªä¾†
    if (birthDate >= today) {
        resultBox.innerHTML = "<p style='color:#c0392b;'>âš ï¸ å‡ºç”Ÿæ—¥æœŸä¸èƒ½æ˜¯æœªä¾†ï¼</p>";
        // æ¸…é™¤ä¸Šæ¬¡çµæœ
        localStorage.removeItem(STORAGE_KEY);
        return;
    }

    // 1. è¨ˆç®—ç‹—ç‹—å¹´é½¡ (ä»¥å¹´ç‚ºå–®ä½)
    const diffMs = today - birthDate;
    const dogAgeYears = diffMs / (1000 * 60 * 60 * 24 * 365.25); // è€ƒæ…®é–å¹´çš„å¹³å‡å¤©æ•¸

    // 2. æ›ç®—äººé¡å¹´é½¡ (ä½¿ç”¨å°æ•¸æ¨¡å‹: $HumanAge = 16 \ln(DogAge) + 31$)
    // é€™æ˜¯åŸºæ–¼ç§‘å­¸ç ”ç©¶çš„ä¸€ç¨®è¼ƒæ–°ã€è¼ƒæº–ç¢ºçš„æ›ç®—æ–¹æ³•
    const humanAge = 16 * Math.log(dogAgeYears) + 31;

    // 3. æ ¼å¼åŒ–è¼¸å‡º
    const dogAgeFixed = dogAgeYears.toFixed(2); // ä¿ç•™å…©ä½å°æ•¸æ›´ç²¾ç¢º
    const humanAgeFixed = Math.round(humanAge);

    const resultHTML = `
        <p>ğŸ‰ **${dogName}** çš„æ­²æ•¸è¨ˆç®—çµæœï¼š</p>
        <ul>
            <li>**ç‹—ç‹—å¯¦éš›å¹´é½¡ï¼š** ç´„ **${dogAgeFixed}** æ­²</li>
            <li>**æ›ç®—äººé¡å¹´é½¡ï¼š** ç´„ **${humanAgeFixed}** æ­²</li>
        </ul>
        <p style="margin-top:10px; font-size: 13px; color: #7f8c8d;">
            ï¼ˆ*äººé¡å¹´é½¡æ›ç®—å…¬å¼ï¼š16 * ln(ç‹—é½¡) + 31*ï¼‰
        </p>
    `;

    resultBox.innerHTML = resultHTML;

    // 4. *** å„²å­˜çµæœåˆ° LocalStorage ***
    const dataToSave = {
        dogName: dogName,
        birthDate: birthDateStr,
        resultHTML: resultBox.innerHTML
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
}

// --- é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–å‡½æ•¸ ---
function initialize() {
    const storedData = localStorage.getItem(STORAGE_KEY);

    if (storedData) {
        const data = JSON.parse(storedData);
        
        // è¼‰å…¥ä¸Šæ¬¡è¼¸å…¥å€¼
        dogNameInput.value = data.dogName || "å¦™éº—";
        birthDateInput.value = data.birthDate || "2023-02-28";
        
        // è¼‰å…¥ä¸Šæ¬¡çš„é‹ç®—çµæœ
        resultBox.innerHTML = data.resultHTML;
        
    } else {
        // å¦‚æœæ²’æœ‰å„²å­˜çš„è³‡æ–™ï¼Œåˆå§‹åŒ–è¼¸å…¥æ¡†ä¸¦æ¸…ç©ºçµæœ
        dogNameInput.value = dogNameInput.value || "å¦™éº—";
        birthDateInput.value = birthDateInput.value || "2023-02-28";
        resultBox.innerHTML = "";
    }
}


// --- äº‹ä»¶ç›£è½èˆ‡åŸ·è¡Œ ---

// 1. æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šåŸ·è¡Œè¨ˆç®—èˆ‡å„²å­˜
calcBtn.addEventListener("click", calculateAndDisplayAge);

// 2. é é¢è¼‰å…¥äº‹ä»¶ï¼šè¼‰å…¥ä¸Šæ¬¡è³‡æ–™ (å¯¦ç¾é‡æ–°æ•´ç†å¾Œé¡¯ç¤ºä¸Šæ¬¡çµæœ)
document.addEventListener("DOMContentLoaded", initialize);
